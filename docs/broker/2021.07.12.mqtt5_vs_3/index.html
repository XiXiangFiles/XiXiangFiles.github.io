<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-broker/2021.07.12.mqtt5_vs_3">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">[深入淺出MQTT]:  v3.1.1與v5 的差異 | jerry.wang&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://wangs.cloud/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://wangs.cloud/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://wangs.cloud/docs/broker/2021.07.12.mqtt5_vs_3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[深入淺出MQTT]:  v3.1.1與v5 的差異 | jerry.wang&#x27;s blog"><meta data-rh="true" name="description" content="MQTT v3.1.1 與 v5 完全相容，且提供許多Cluster 所需要的功能，如Shared Subscriptions、 User Properties等實用功能，且不會因為新增加功能造成效能低落的問題。"><meta data-rh="true" property="og:description" content="MQTT v3.1.1 與 v5 完全相容，且提供許多Cluster 所需要的功能，如Shared Subscriptions、 User Properties等實用功能，且不會因為新增加功能造成效能低落的問題。"><meta data-rh="true" name="keywords" content="mqtt,m2m"><link data-rh="true" rel="icon" href="/img/programmer.png"><link data-rh="true" rel="canonical" href="https://wangs.cloud/docs/broker/2021.07.12.mqtt5_vs_3"><link data-rh="true" rel="alternate" href="https://wangs.cloud/docs/broker/2021.07.12.mqtt5_vs_3" hreflang="en"><link data-rh="true" rel="alternate" href="https://wangs.cloud/docs/broker/2021.07.12.mqtt5_vs_3" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CV3DEYG0V5"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-CV3DEYG0V5",{})</script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.21f63a90.css">
<link rel="preload" href="/assets/js/runtime~main.b3f86e02.js" as="script">
<link rel="preload" href="/assets/js/main.30932032.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Jerry.Wang Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://www.linkedin.com/in/zi-xiang-wang-56073a1a2/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Jerry Wang Blog</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/golang/2021.10.23.advance_golang">Golang</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/database/2021.04.18.smalltalk_nosql">Database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/http/2020.11.25.overview_the_websocket_mechanism">HTTP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/patterns/2021.09.04.from_mod_to_structure">Pattern</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/broker/2020.11.11.what_is_broker">Broker</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/broker/2020.11.11.what_is_broker">Broker 到底是什麼</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/broker/2021.07.12.mqtt5_vs_3">[深入淺出MQTT]:  v3.1.1與v5 的差異</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/blockchain/2021.03.07.blockchain_issues">Blockchain</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/k8s/2022.02.14.shorttalk_k8s">Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/security/2020.12.20.auth_2_tutorial">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/torch/2020.11.04.torch_server_tutorial">Torch</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/web_rtc/2020.11.19.apprtc_tutorial">WebRTC</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Broker</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">[深入淺出MQTT]:  v3.1.1與v5 的差異</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>[深入淺出MQTT]<!-- -->:  v3.1.1與v5 的差異</h1><p>MQTT 起初是由 IBM 在 1999 年提出的，是針對 IoT 裝置設計的 MQ，是屬於發展許久的 MQ。主要設計的原則是：</p><ol><li>Simple implementation: 可以簡單的被使用。</li><li>Quality of Service data delivery: 提供不同程度的Data 傳輸品質。</li><li>Lightweight and bandwidth efficient: 輕量化且高頻寬的效能。</li><li>Data agnostic: 使用者不用理會資料怎麼來。</li><li>Continuous session awareness: 當client中斷連線之後，可以重新連線並且訊息不會消失。</li></ol><p>雖然起出被設計用於 IoT (Internet of Thing) 裝置，但目前MQ被廣泛運用在Platform因此在2019 年時MQTT正式提出v5版本更被推薦，主要就是為了platform 平台新的需求新增加功能。(目前市面上有兩個版本，v3.1.1、v.5) MQTT Architecture</p><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*_adP484gIyNNVAvYRZDmVQ.png" alt="MQTT Architecture" class="img_ev3q"></p><p><strong>MQTT v3.1.1 Features</strong></p><p>在功能面MQTT 是以 v3.1.1作為基礎的功能，而v5則是為雲服務進行擴充但也更改一些特性，如<strong>QoS...</strong>。MQTT與傳統意義有些許不一樣。如下比較表:</p><table><thead><tr><th></th><th><strong>MQTT</strong></th><th><strong>TraditionalMQ</strong></th></tr></thead><tbody><tr><td>Persistent Message</td><td>當consumer 取的訊息之前，可設定將訊息保存在MQ中，直到被取用</td><td>當consumer 取的訊息之前，可設定將訊息保存在MQ中，直到被取用</td></tr><tr><td>Distribution Ability</td><td>透過Topic的方式可很輕鬆的進行傳遞給多個consumer</td><td>傳統的consumer與queue是一對一的綁定，不太能分享訊息</td></tr><tr><td>Queue Name</td><td>使用上完全不用理會name 是否衝突的問題，只要在乎想訂閱的Topic</td><td>須自行管理queue 的name</td></tr></tbody></table><p><strong>MQTT v3.1.1主要功能</strong>有QoS、Topic、Persistent Session(重新連線後Topic還存在)、Retained Messages、Last Will。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-qosquality-of-service-"><strong>1. Qos(Quality of Service):</strong> <a href="#1-qosquality-of-service-" class="hash-link" aria-label="Direct link to 1-qosquality-of-service-" title="Direct link to 1-qosquality-of-service-">​</a></h3><p>代表的是發送與接收訊息的品質，可設定0-2這個區間。</p><ul><li><em>At most once</em> (0): Producer 就是單純發送之後不用確認是否broker有收到；Broker 發送至consumer也不會確認是否收到。</li></ul><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*fR9iCJnuoxGEZI6Zb4SGSQ.png" class="img_ev3q"></p><ul><li><em>At least once</em> (1): Producer 就是單純發送之後會等待 <strong>PUBACK 封包確認有收到</strong>；同理Broker 發送至consumer也需等待<strong>PUBACK</strong>。</li></ul><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*0Cp2cDaXuXdMUv49JaxGKQ.png" class="img_ev3q"></p><ul><li><em>Exactly once</em> (2): Producer 每發送訊息之後<strong>就會進行3向交握</strong>，確認是否有收到，併保證只收到一次；同理consumer 接收broker 訊息也是如此。</li></ul><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*rANapuhzHKjB794P7rNweg.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-topic"><strong>2. Topic</strong><a href="#2-topic" class="hash-link" aria-label="Direct link to 2-topic" title="Direct link to 2-topic">​</a></h3><p>MQTT Topic是由utf-8 編碼組成，如Http的URL的概念，透過&quot;/&quot;進行分階層。如下圖，myhome階層下groundfloor、livingroom、temperature等，如同REST 架構中對於URI的規範類似。</p><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*FOrZN9a90ffw8CxO8NW0Pg.png" class="img_ev3q"></p><p><strong>2.1 Topic 特殊符號:</strong></p><ul><li>”＃”: 代表的垂直的概念，指的是該階層以下的全部Topic都訂閱，\
ex: myhome/groundfloor/#，表示訂閱myhome/groundfloor/kitchen、myhome/groundfloor/livingroom、myhome/groundfloor/livingroom/..的意思。</li></ul><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*xssnk2qlEhWiU2FEk_jBuw.png" class="img_ev3q"></p><ul><li>”＋”: 代表水平的概念，使用該符號的階層所處的階層可以替換成任何字元。ex: 以myhome/groundfloor/+/temperature為例，”＋”可替換成kitchen、livingroom 的概念。\
代表同時訂閱: myhome/groundfloor/kitchen/temperature、myhome/groundfloor/livingroom/temperature等Topic。</li></ul><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*KYgWaWcirCoUKgNMPiYzsw.png" class="img_ev3q"></p><ul><li>”＄”: 以此關鍵字為首的併不支援訂閱的，該關鍵字是MQTT用於輸出內部狀態的保留字。ex: $SYS/broker/clients/connected，可取得有多少裝置連線。\</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-persistent-session-"><strong>3. Persistent Session:</strong> <a href="#3-persistent-session-" class="hash-link" aria-label="Direct link to 3-persistent-session-" title="Direct link to 3-persistent-session-">​</a></h3><p>當clinet 對MQTT 連線斷掉時，Topic 將會自動的discard。但為了解決這個問題，Persistent Serssion的設計就是為了解決這個問題而生。</p><p>有效時broker 存取的東西：</p><ul><li>Existence of a session (even if there are no subscriptions).</li><li>所有的subscription 。</li><li>QoS 尚未完成傳輸的message。</li><li>QoS 1、2 尚未傳給Client的message都會留存。</li><li>所有QoS 2 未完成Ack的message 。</li></ul><p><strong>Persistent Session使用方式</strong>\
就是在連線的時候需要將option的clean session 設定為false。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-retained-messages-"><strong>4. Retained Messages:</strong> <a href="#4-retained-messages-" class="hash-link" aria-label="Direct link to 4-retained-messages-" title="Direct link to 4-retained-messages-">​</a></h3><p>主要是在producer上的功能，發送訊息後會將訊息保持在Topic 上，使的新的加入者也可以獲取最新的息。若在沒有設定的情況下，新加入的consumer不會收到上一個以發送過的訊息。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-last-will-and-testamentlwt"><strong>5. Last Will and Testament(lwt)</strong><a href="#5-last-will-and-testamentlwt" class="hash-link" aria-label="Direct link to 5-last-will-and-testamentlwt" title="Direct link to 5-last-will-and-testamentlwt">​</a></h3><p>是在producer上的功能，當Producer斷線的時候，可指定lwt的Topic，與想要傳送的訊息。這功能主要用來debug用的，官方提供這種功能很適合放在上online and offline 的管理上。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mqtt-v5-features-and-v-311-features-comparison"><strong>MQTT v5 features and v 3.1.1 features comparison</strong><a href="#mqtt-v5-features-and-v-311-features-comparison" class="hash-link" aria-label="Direct link to mqtt-v5-features-and-v-311-features-comparison" title="Direct link to mqtt-v5-features-and-v-311-features-comparison">​</a></h3><p>在這個版本中整體使用方式，MQTT v5與v3.1.1之間功能上的的差別在於 QoS 1 以上不再重傳訊息、retained messages、persistent sessions不再支援了。</p><ol><li><strong>MQTT QoS</strong> <em>v5 、v3.1</em>.1 之間的定義是一樣的，但v5 的版本不在TCP 連線健康的情況下重傳訊息。              \
原先的v3.1.1 版本若在一段時間內沒收到 ack 將會在retry，這可能造成因為效能問題導致未回傳的裝置loading 更重。</li><li>retained messages: v5中Message Expiry Interval用來取代此功能，可以將其設定一個時間後併刪除。</li><li>persistent sessions: 在v3.1.1中若中途有producer將clean session設定為true時，之前所存的message將會被一起被刪除，v5 中Session Expiry Interval 進來取代此功能。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mqtt-v5-user-properties"><strong>MQTT v5 User Properties</strong><a href="#mqtt-v5-user-properties" class="hash-link" aria-label="Direct link to mqtt-v5-user-properties" title="Direct link to mqtt-v5-user-properties">​</a></h3><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*Yfw6ZIl78ytsuQlFPZiuQQ.gif" class="img_ev3q"></p><p>類似http header 的概念，可以在每一個訊息上加入一個property header ，consumer 端可依賴該欄位進行運用。Broker 根據consumer 所訂閱的設定進行訊息routing。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mqtt-v5-shared-subscriptions"><strong>MQTT v5 Shared Subscriptions</strong><a href="#mqtt-v5-shared-subscriptions" class="hash-link" aria-label="Direct link to mqtt-v5-shared-subscriptions" title="Direct link to mqtt-v5-shared-subscriptions">​</a></h3><p>在v5的版本中，原生支援load balance的功能，consumer 可在建立連線的時候設定Broker shared選項綁定多個consumer 成為一個群組。</p><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/800/1*pw7M8FeLqakSYl5TwKRv7A.gif" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mqtt-v311-vs-mqtt-v5能力比較">MQTT v3.1.1 v.s MQTT v5能力比較<a href="#mqtt-v311-vs-mqtt-v5能力比較" class="hash-link" aria-label="Direct link to MQTT v3.1.1 v.s MQTT v5能力比較" title="Direct link to MQTT v3.1.1 v.s MQTT v5能力比較">​</a></h3><p>在Intel i7 9750H、16GB RAM在Docker 環境下測試，其中使用 eclipse-mosquitto:2.0.11 Image 作為MQTT broker。由於MQTT v5的版本在Open Source 社群上並未完整支援，以<a href="https://www.eclipse.org/paho/index.php?page=downloads.php" target="_blank" rel="noopener noreferrer">Eclipse MQTT </a>社群為例，目前完整支援MQTT v5的只有Java、Python、C/C++等三種。</p><p><img loading="lazy" src="/assets/images/image (6) (1)-0739f2f670405f2e6eda4f777daa020a.png" width="1182" height="547" class="img_ev3q"></p><p>但實際使用Java、Python 發現並未完全支援，只有C語言有完整支援，如下圖所示。因此在實驗的部份採用Mosquitto 所提供的mosquitto<!-- -->_<!-- -->pub 作為Publisher；使用npm 平台的mqtt v4.2.6版本作為Subscriber進行實做。由於Nodejs該模組在publish 的部份，會因Nodejs中的Event 排程受到影響，因此只使用Subscriber 功能。</p><p><img loading="lazy" src="/assets/images/image (1) (1) (2)-5d75094b501414f6170a6f843596b39b.png" width="725" height="442" class="img_ev3q"></p><p>實驗分為兩種測試，<strong>吞吐量測試(TPS)、精準度測試(QoS)</strong>。<em><strong>吞吐量測試</strong></em>分為Publisher與Subscriber 兩種角色，在<em>Publisher 的配置以1、3、5、7、10 個Publisher</em> 進行測試；Subscriber 同 Publisher ，<em>分成1、3、5、7、10 個</em> Subscriber的場景配置，<strong>將發送100萬個封包計算平均每秒的吞吐量</strong>。<em><strong>精準度測試的部份</strong></em>，<em>配置分成1、3、5、7、10 個</em> Subscriber<em>與1個 Publisher進行測試，將發送100萬個訊息，平均計算每個Subscriber收到的數量</em>。</p><ul><li>吞吐量測試(TPS): <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mi>P</mi><mi>S</mi><mo>=</mo><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">TPS = requests/per second</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05764em">TPS</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mord">/</span><span class="mord mathnormal">p</span><span class="mord mathnormal">erseco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span></span></span></span></span> </li><li>精準度測試(Qos) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>s</mi><mi>u</mi><mi>m</mi><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>r</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>R</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>R</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">Precision= sum(correct Request)/Requests</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord mathnormal">rec</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">correc</span><span class="mord mathnormal" style="margin-right:0.00773em">tR</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span></span></span></span></span> </li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="測試1--1-3-5-7-10--publisher--1-subscriber-">測試1- <!-- -->[<!-- -->1, 3, 5, 7 ,10 ] publisher + 1 subscriber<!-- --> <a href="#測試1--1-3-5-7-10--publisher--1-subscriber-" class="hash-link" aria-label="Direct link to 測試1--1-3-5-7-10--publisher--1-subscriber-" title="Direct link to 測試1--1-3-5-7-10--publisher--1-subscriber-">​</a></h4><p>當Publisher 增加時，Publisher TPS 明顯的下降，但Subscriber TPS 則線性成整且QoS不變，代表著mosquitto不會因為封包數量變大，造成不一樣的Qos。換句話說Client (Publisher) 之間並不會互相影響Subscriber所收集到的資訊。</p><p><img loading="lazy" src="/assets/images/image (9) (1)-83a9cf941a1cf502b5368638a623d282.png" width="1249" height="308" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="測試2--1-publisher--1-3-5-7-10---subscriber"><strong>測試2- 1 publisher + <!-- -->[<!-- -->1, 3, 5, 7 ,10 ]  subscriber</strong><a href="#測試2--1-publisher--1-3-5-7-10---subscriber" class="hash-link" aria-label="Direct link to 測試2--1-publisher--1-3-5-7-10---subscriber" title="Direct link to 測試2--1-publisher--1-3-5-7-10---subscriber">​</a></h4><p>當Subscriber 增加時，Publisher TPS 並沒有什麼改變，且Subscriber TPS、QoS也不變，代表著mosquitto不會因為封包數量變大，造成不一樣的Qos。換句話說Client (Subscriber)之間並不會互相影響。</p><p><img loading="lazy" src="/assets/images/image (11) (1)-fd4a0131155e651c8f1b3ca8bd9f24fd.png" width="1238" height="308" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="測試3--1-publisher--1-subscriber以一次1000100004000070000100000-送出訊息達1000000-條訊息後紀錄tpsqos取平均值"><strong>測試3- 1 publisher + 1 subscriber，以一次1000、10,000、40,000、70,000、100,000 送出訊息，達1,000,000 條訊息後，紀錄TPS、QoS取平均值。</strong><a href="#測試3--1-publisher--1-subscriber以一次1000100004000070000100000-送出訊息達1000000-條訊息後紀錄tpsqos取平均值" class="hash-link" aria-label="Direct link to 測試3--1-publisher--1-subscriber以一次1000100004000070000100000-送出訊息達1000000-條訊息後紀錄tpsqos取平均值" title="Direct link to 測試3--1-publisher--1-subscriber以一次1000100004000070000100000-送出訊息達1000000-條訊息後紀錄tpsqos取平均值">​</a></h4><p>在Publisher當一次傳輸的封包變少時，TPS、QoS 會以指數的方式成長。一次的數量超過極限的吞吐量，則會造成Subscriber QoS下降，因為mosquitto 預設機制為當QoS &gt; 0時，broker內部給單一個Client的內存queue封包數量為1000條訊息。因此只要超過一定的吞吐量會造成QoS降低。同時訊息數量大，會造成壅塞的情形，使Publisher、Subscriber 的 TPS 受到影響。</p><p><img loading="lazy" src="/assets/images/image (10) (1) (1)-403b5e221f9e45d61d045d23aea05ed3.png" width="1235" height="326" class="img_ev3q"></p><p>Subscriber 與 Publisher 都以QoS 為2的狀態下盡情測試，mosquitto 以預設值進行量測。發現MQTT v3.11、v5 並未有明顯差異，且v5的效能些微比v3來的弱一點。<em><strong>且透過上述實驗可得到以下幾點結論:</strong></em></p><ol><li>使用MQTT時，未必將QoS調整到越高越好，由於當QoS &gt; 0時 Broker將會限制client緩存Queue，就有可能發生Publisher 送出的資料被Broker捨棄的問題，以致實際QoS降低。</li><li>MQTT Broker並不這麼適合用來當Micro Service中的Broker，由於無法正確預期資料的傳輸，有可能因此導致重要的錯誤。</li><li>在大部分情況建議MQTT的QoS設置為0會更好，由於MQTT本基於TCP，因此保證其一定會送至或傳輸到目的地。然而若 QoS &gt; 0則會因為一些確認機制導致變慢，使得TPS、QoS 不如預期。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="結論">結論<a href="#結論" class="hash-link" aria-label="Direct link to 結論" title="Direct link to 結論">​</a></h3><p>MQTT v3.1.1、 v5效能並未有大的差異，且v5的版本提供更多的功能。雖然官方文件上所述QoS的實作方面有受到調整，但經過測試後並未有大的差異，但市場上的所提供的工具目前很少，相信未來MQTT v5的版本是比v3.1.1來的更好更實用的。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/broker/2020.11.11.what_is_broker"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Broker 到底是什麼</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/blockchain/2021.03.07.blockchain_issues"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">區塊鏈物聯網架構 解決哪些安全性議題？</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-qosquality-of-service-" class="table-of-contents__link toc-highlight"><strong>1. Qos(Quality of Service):</strong> </a></li><li><a href="#2-topic" class="table-of-contents__link toc-highlight"><strong>2. Topic</strong></a></li><li><a href="#3-persistent-session-" class="table-of-contents__link toc-highlight"><strong>3. Persistent Session:</strong> </a></li><li><a href="#4-retained-messages-" class="table-of-contents__link toc-highlight"><strong>4. Retained Messages:</strong> </a></li><li><a href="#5-last-will-and-testamentlwt" class="table-of-contents__link toc-highlight"><strong>5. Last Will and Testament(lwt)</strong></a></li><li><a href="#mqtt-v5-features-and-v-311-features-comparison" class="table-of-contents__link toc-highlight"><strong>MQTT v5 features and v 3.1.1 features comparison</strong></a></li><li><a href="#mqtt-v5-user-properties" class="table-of-contents__link toc-highlight"><strong>MQTT v5 User Properties</strong></a></li><li><a href="#mqtt-v5-shared-subscriptions" class="table-of-contents__link toc-highlight"><strong>MQTT v5 Shared Subscriptions</strong></a></li><li><a href="#mqtt-v311-vs-mqtt-v5能力比較" class="table-of-contents__link toc-highlight">MQTT v3.1.1 v.s MQTT v5能力比較</a></li><li><a href="#結論" class="table-of-contents__link toc-highlight">結論</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Jerry.wang blog, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b3f86e02.js"></script>
<script src="/assets/js/main.30932032.js"></script>
</body>
</html>